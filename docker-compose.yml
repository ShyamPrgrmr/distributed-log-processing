services:
  logs-generator:
    image: shyamya/logs-generator:latest
    container_name: logs-generator
    volumes:  
      - logs-storage:/app/logs:rw
    env_file:
      - ./loggenerator/.env
    environment:
      - COMPONENT_TO_USE=payment_processor,api_gateway

  fluentd:
    container_name: fluentd
    depends_on:
      - kafka-broker-1
    build:
      context: ./fluentd 
    volumes:
      - logs-storage:/tmp/logs:ro
      - fluentd-pos:/tmp/pos:rw
    networks:
      - logs-network
    env_file:
      - ./fluentd/.env

  kafka-controller-1:
    image: apache/kafka:latest
    container_name: kafka-controller-1
    hostname: kafka-controller-1

    environment:
      KAFKA_NODE_ID: 1
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-controller-1:9092
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka-controller-1:9093

    volumes:
      - ./kafka/data/kafka-controller-1:/tmp/kraft-combined-logs
    
    env_file:
      - ./kafka/conf/.controller.env

    networks:
      - logs-network

  kafka-broker-1:
    image: apache/kafka:latest
    container_name: kafka-broker-1
    hostname: kafka-broker-1

    depends_on:
      - kafka-controller-1

    volumes:
      - ./kafka/data/kafka-broker-1:/tmp/kraft-broker-logs

    environment:
      KAFKA_NODE_ID: 2
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-broker-1:9092
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka-controller-1:9093
    
    env_file:
      - ./kafka/conf/.broker.env

    networks:
      - logs-network

  logstash:
    container_name: logstash
    
    build: 
      context: ./logstash
    
    env_file:
      - ./logstash/.env

    environment:
      - ES_CO_NODES=http://es-coord-1:9200
      - KAFKA_BROKERS=kafka-broker-1:9092

    networks:
      - logs-network

  es-coord:
    depends_on:
      - es-data
    container_name: es-coord
    build: 
      context: ./elasticsearch/coordination_node
    env_file:
      - ./elasticsearch/coordination_node/.env
    environment:
      - node.name=es-coord
    networks:
      - logs-network

  es-init:
    build: 
      context: ./elasticsearch/elasticsearch-init
    container_name: es-init
    depends_on:
      - es-coord
    environment:
      - ES_HOST=http://es-coord:9200
    networks:
      - logs-network
    restart: "no"

  es-data:
    container_name: es-data
    build: 
      context: ./elasticsearch/data_node
    env_file:
      - ./elasticsearch/data_node/.env
    environment:
      - node.name=es-data
    networks:
      - logs-network
    volumes:
      - es-data:/usr/share/elasticsearch/data

  kibana:
    container_name: kibana
    build:
      context: ./kibana
    depends_on:
      - es-coord
    environment:
      - ELASTICSEARCH_HOSTS=http://es-coord:9200
    ports:
      - "5601:5601"
    networks:
      - logs-network

networks:
  logs-network:
    external: true

volumes:
  logs-storage:
    external: true
  fluentd-pos:
  es-data:
    external: true
