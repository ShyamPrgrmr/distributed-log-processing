input {
  kafka {
    bootstrap_servers => "${KAFKA_BROKERS}"
    topics            => ["${KAFKA_TOPIC}"]
    group_id          => "${KAFKA_GROUP_ID}"
    auto_offset_reset => "latest"
    codec             => json
  }
}

filter {
  grok {
    match => {
      "message" => "%{TIMESTAMP_ISO8601:log.timestamp}\s+%{LOGLEVEL:log.level}\s+%{INT:process.pid}\s+---\s+\[%{DATA:process.thread.name}\]\s+%{DATA:service.name}\s+\[traceId=%{DATA:trace.id}\s+spanId=%{DATA:span.id}\s+paymentId=%{DATA:labels.payment_id}\]\s+:\s+%{GREEDYDATA:tmp.message}"
    }
  }

  mutate {
    replace => {
      "message" => "%{tmp.message}"
    }
  }

  date {
    match => ["log.timestamp", "yyyy-MM-dd HH:mm:ss"]
    target => "@timestamp"
  }

  # Rename hostname safely
  if [hostname] {
    mutate {
      rename => { "hostname" => "[host][name]" }
    }
  }

  # Rename application ONLY if service.name not already set
  if [application] and ![service][name] {
    mutate {
      rename => { "application" => "[service][name]" }
    }
  }

  mutate {
    remove_field => [
      "log.timestamp",
      "process.pid",
      "process.thread.name",
      "@version",
      "log.file",
      "tmp.message"
    ]
  }

  # Guarantee service.name
  if ![service][name] {
    mutate {
      add_field => { "[service][name]" => "unknown-service" }
    }
  }

  mutate {
    lowercase => [ "[service][name]" ]
    gsub => [
      "[service][name]", "[^a-z0-9_-]", "-"
    ]
  }
}

output {
  elasticsearch {
    hosts => ["http://es-coord:9200"]
    index => "%{[service][name]}-%{+YYYY.MM.dd}"
    manage_template => false
  }
  stdout {
    codec => json_lines
  }
}
